<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h1>QR Ticket Manager</h1>
<div>
    <button id="generate" class="btn btn-primary">Generate QR Code</button>
    <div id="qr-code" class="mt-3"></div>
</div>

<div class="mt-5">
    <h3>Scan Ticket</h3>
    <button id="start-scan" class="btn btn-success">Open Camera</button>
    <div id="reader" class="mt-3" style="width: 300px;"></div>
    <div id="scan-result" class="mt-3"></div>
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
    // Проверка, доступен ли Telegram WebApp SDK
    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready();
    }

    const apiBase = 'http://localhost:5000';

    document.getElementById('generate').addEventListener('click', async () => {
        const response = await fetch(`${apiBase}/generate`, {method: 'POST'});
        const data = await response.json();
        document.getElementById('qr-code').innerHTML = `<img src="${apiBase}/${data.qr_code}" alt="QR Code" />`;
    });

    document.getElementById('start-scan').addEventListener('click', () => {
        const html5QrCode = new Html5Qrcode("reader");

        const qrCodeSuccessCallback = async (decodedText) => {
            html5QrCode.stop();
            const response = await fetch(`${apiBase}/check`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ticket_id: decodedText}),
            });
            const data = await response.json();
            document.getElementById('scan-result').textContent = data.message;
        };

        const qrCodeErrorCallback = (error) => {
            console.warn(`QR code scan error: ${error}`);
        };

        // Стартуем камеру
        html5QrCode.start(
            {facingMode: "environment"}, // Камера по умолчанию - задняя
            {fps: 10, qrbox: 250},
            qrCodeSuccessCallback,
            qrCodeErrorCallback
        ).catch(err => {
            console.error(`Unable to start scanning: ${err}`);
        });
    });
</script>
</body>
</html>
